<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.6" />
<title>Luaf, the binding of Lua to Fortran 2003/2008</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

pre {
  padding: 0;
  margin: 0;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }


/*
 * xhtml11 specific
 *
 * */

tt {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

.monospaced {
  font-family: monospace;
  font-size: inherit;
  color: navy;
}

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}
</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install(2);
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>Luaf, the binding of Lua to Fortran 2003/2008</h1>
<span id="author">Vadim Zborovskii</span><br />
<span id="email"><tt>&lt;<a href="mailto:vzborovsky@gmail.com">vzborovsky@gmail.com</a>&gt;</tt></span><br />
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p><em>Fortran</em> is a well-known traditional language for scientific
 and engineering numerical simulations.</p></div>
<div class="paragraph"><p><em>Lua</em> (<a href="http://www.lua.org">http://www.lua.org</a>) is a modern lightweight embeddable language.</p></div>
<div class="paragraph"><p><em>Luaf</em> is the set of Fortran bindings to Lua.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
<div class="title">Why to bind Fortran and Lua together?</div>
<div class="paragraph"><p>Fortran has poor abilities to deal with intricate data structures.
It is convenient to use Lua for configuration and some pre/postprocessing steps.</p></div>
<div class="paragraph"><p>Or, for example, you want to specify some input functions
(for example, material properties, space- and time-dependent terms etc).
It&#8217;s better to take advantage of mature language
 for dealing with formulas instead of DIY interpeter in Fortran.
See also: <a href="https://en.wikipedia.org/wiki/Greenspun%27s_tenth_rule">Greenspun&#8217;s tenth rule</a>.</p></div>
</td>
</tr></table>
</div>
<div class="paragraph"><p>Fortran 2003/2008 provides so-called &#8220;interoperability with C&#8221; that allows
creating transparent bindings to most of procedures with C interface. Thus some
projects of Lua bindings in Fortran have been recently developed.</p></div>
<div class="sect2">
<h3 id="_similar_projects">Similar projects</h3>
<div class="ulist"><ul>
<li>
<p>
<a href="https://bitbucket.org/haraldkl/aotus/">AOTUS</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/adolgert/FortLua/">FortLua</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/MaikBeckmann/f2k3-lua/tree/simple">f2k3-lua</a>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_rationale">Rationale</h3>
<div class="paragraph"><p>This project aims to implement full-scale bindings of Lua API including
facitilites to read configuration files and call user-defined functions. However,
it can (and shall!) be used for configuration and extension of Fortran programs.</p></div>
<div class="paragraph"><p>The secondary objectives include minimal dependencies and automation of
bindings generation.</p></div>
</div>
<div class="sect2">
<h3 id="_to_do">To do</h3>
<div class="paragraph"><p>The current version supports Lua 5.1. It is planned to make the bindings for Lua
5.2.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lua_api_implemented">Lua API implemented</h2>
<div class="sectionbody">
<div class="paragraph"><p>Almost all Lua 5.1 API functions, macros and constant defined in the
<a href="http://www.lua.org/manual/5.1/">Lua manual</a> are implemented. In the following
sections I describe the differences from C API.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Please read the <a href="#interop">Interoperability issues</a> section also.
When in doublt, please read source file <em>luaf.f90</em>.</td>
</tr></table>
</div>
<div class="sect2">
<h3 id="_functions">Functions</h3>
<div class="paragraph"><p>Bindings to <strong>all</strong> Lua functions including debug and auxiliary libraries are
implemented, with the exception of variadic functions:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>lua_pushfstring</tt>
</p>
</li>
<li>
<p>
<tt>lua_pushvfstring</tt>
</p>
</li>
<li>
<p>
<tt>luaL_error</tt>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Variadic functions are not &#8220;interoperable&#8221; in the state-of-art Fortran
standard and implementations.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">The bindings have the same names as corresponding C functions, except
<tt>lua_yield</tt>. The latter was renamed to <tt>lua_yield1</tt> to avoid conflicts with
<tt>LUA_YIELD</tt> constant.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_macros">Macros</h3>
<div class="paragraph"><p>Almost all macros are implemented as Fortran functions. For some macros, it&#8217;s better
to use corresponding <a href="#wrap">Fortran wrapper</a>. See the table below.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="50%" />
<col width="50%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Instead of &#8230;</p></td>
<td align="left" valign="top"><p class="table">Use &#8230;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>lua_pushliteral</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>lua_pushstring_f</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>lua_tostring</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>lua_tostring_f</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>lua_checkstring</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>lua_checkstring_f</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>lua_optstring</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>lua_optstring_f</tt></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"><tt>lua_typename</tt></p></td>
<td align="left" valign="top"><p class="table"><tt>lua_typename_f</tt></p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="title">Rationale</div>All macros that return C string are replaced with wrappers returning Fortran
string. As for <tt>lua_pushliteral</tt>, the length of Fortran string is always known.
So there is no point to discriminate between &#8220;literals&#8221; and &#8220;strings&#8221;.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">Macros <tt>luaL_addchar</tt> and <tt>luaL_addsize</tt> use C pointer arithmetics.
They are implemented in a not completely portable way. See <a href="#cptrs">C pointers</a>.</td>
</tr></table>
</div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">Implemented macros use <strong>Fortran</strong> integral types and <strong>C</strong> strings.
This is subject to change in the future.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_call_by_reference_versions">Call-by-reference versions</h3>
<div class="paragraph"><p>For some functions:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>lua_getallocf</tt>
</p>
</li>
<li>
<p>
<tt>luaL_register</tt>
</p>
</li>
<li>
<p>
<tt>luaL_checkoption</tt>
</p>
</li>
<li>
<p>
<tt>luaL_loadfile</tt>
</p>
</li>
<li>
<p>
<tt>luaL_dofile</tt>
</p>
</li>
</ul></div>
<div class="paragraph"><p>argument can either point to input/output
variable or be <tt>NULL</tt>. Therefore in addition to the &#8220;basic&#8221; binding which
declares this argument as C pointer, the special version with suffix <tt>_r</tt>
(e.g., <tt>luaL_loadfile_r</tt>) where the argument is passed by reference.</p></div>
</div>
<div class="sect2">
<h3 id="_fortran_wrappers">Fortran wrappers</h3>
<div class="paragraph" id="wrap"><p>I have written convenience wrappers for some functions and macros. The first
reason to write wrapper is the conversion of function return value from C string
passed as <tt>char *</tt> to Fortran string passed as <tt>INTENT(INOUT)</tt> dummy argument
with some assumed length. The second reason is to pass the length of Fortran
string (which is certainly known during the call) to <tt>lua&#8230;lstring&#8230;</tt> functions
where the explicit string length is desired.</p></div>
<div class="paragraph"><p>All wrappers have the <tt>_f</tt> suffix appended to their names. They are declared as
subroutines accepting Fortran integers and strings. Please consult the source
file <em>luaf.f90</em> for information.</p></div>
<div class="paragraph"><p>Here is the list of convenience wrappers:</p></div>
<div class="ulist"><ul>
<li>
<p>
<tt>lua_typename_f</tt>
</p>
</li>
<li>
<p>
<tt>lua_tolstring_f</tt>
</p>
</li>
<li>
<p>
<tt>lua_pushstring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_checklstring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_optlstring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_gsub_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_addstring_f</tt>
</p>
</li>
<li>
<p>
<tt>lua_tostring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_checkstring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_optstring_f</tt>
</p>
</li>
<li>
<p>
<tt>luaL_typename_f</tt>
</p>
</li>
</ul></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_interoperability_issues">Interoperability issues</h2>
<div class="sectionbody">
<div class="paragraph" id="interop"><p>C and Fortran have different type systems. This section deals with some explicit
and implicit points of difference.</p></div>
<div class="sect2">
<h3 id="_c_and_fortran_integers">C and Fortran integers</h3>
<div class="paragraph"><p>Lua uses the four C integer types: <tt>int</tt>, <tt>long</tt>, <tt>size_t</tt> and <tt>lua_Integer</tt>,
which is the same as <tt>ptrdiff_t</tt>.</p></div>
<div class="paragraph"><p>In function bindings and their call-by-reference counterparts these types are
mapped to Fortran kinds &#8220;as is&#8221;: <tt>C_INT</tt>, <tt>C_SIZE_T</tt>, <tt>C_INTPTR_T</tt>. See
Fortran 2003/2008 reference for details. <tt>long</tt> is not used there.</p></div>
<div class="paragraph"><p>In macros and convenience wrappers, <tt>INTEGER(8)</tt> is used for <tt>long</tt> and default
<tt>INTEGER</tt> is used otherwise. This is reasonable assumption for present-day
Fortran compilers.</p></div>
</div>
<div class="sect2">
<h3 id="_c_and_fortran_strings">C and Fortran strings</h3>
<div class="paragraph"><p>C strings are arrays of chars terminated by null char with the length unknown <em>a
priori</em>. Fortran strings are special variant of <tt>CHARACTER</tt> type with <tt>LENGTH</tt>
parameter greater than one. Their length is always known if the string variable
is accessible.</p></div>
<div class="sect3">
<h4 id="_conversion_subroutines">Conversion subroutines</h4>
<div class="paragraph"><p>I have written four conversion subroutines between C and Fortran strings.</p></div>
<div class="paragraph"><p><tt>F_C_STR</tt> takes Fortran string and appends null char making it alike the C
string. Note that it doesn&#8217;t return <tt>CHARACTER</tt> array but rather returns Fortran
string of kind <tt>C_CHAR</tt> with length increased by one. Such string can be
implicitly converted to <tt>CHARACTER(KIND=C_CHAR)</tt> array when passed as argument
(see below).</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content"><tt>C_CHAR</tt> character kind is assumed to be the same as default one. This
is valid at least for GNU Fortran and Intel Fortran. Also, the length of C
character is supposed to be 1 byte in the <tt>luaL_addchar</tt> and <tt>luaL_addsize</tt>
macro implementations.</td>
</tr></table>
</div>
<div class="paragraph"><p><tt>F_C_STRT</tt> does the same after trimming the original string.</p></div>
<div class="paragraph"><p><tt>C_F_STR</tt> unpacks the C string from <tt>TYPE(C_PTR)</tt> pointer to Fortran character
buffer. The end of string occurs at the null char or if the buffer ends. The
truncation flag and actual length are specified as dummy optional output
arguments.</p></div>
<div class="paragraph"><p><tt>C_F_STRL</tt> does the same but actual string length is specified as input. Null
character is ignored. Truncation is signalled as optional output flag.</p></div>
</div>
<div class="sect3">
<h4 id="_string_arguments">String arguments</h4>
<div class="paragraph"><p>For function bindings (including call-by-value versions), C strings are mapped
either as <tt>TYPE(C_PTR)</tt> pointers or as <tt>CHARACTER(KIND=C_CHAR, LEN=1)</tt>
assumed-size arrays. In the latter case, Fortran 2003/2008 standard permits
passing of <tt>CHARACTER(KIND=C_CHAR, LEN=*)</tt> strings as actual arguments by the
so-called sequence association. So, you can just wrap the Fortran string with
<tt>F_C_STR</tt>/<tt>F_C_STRT</tt> and pass it to function.</p></div>
<div class="paragraph"><p>For macros, the things are currently the same.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">If the string length needs to be specified (e.g., in <tt>lua_pushlstring</tt>),
use a <a href="#wrap">wrapper</a>.</td>
</tr></table>
</div>
<div class="paragraph"><p>Convenience wrappers expect Fortran strings as arguments.</p></div>
</div>
<div class="sect3">
<h4 id="_string_return_values">String return values</h4>
<div class="paragraph"><p>For bindings, C strings returned by Lua functions are mapped to opaque
<tt>TYPE(C_PTR)</tt> handle. The subroutines <tt>C_F_STR</tt> and <tt>C_F_STRL</tt> convert it to
Fortran string. For simplicity, such functions always have <a href="#wrap">wrappers</a>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_c_pointers">C pointers</h3>
<div class="paragraph" id="cptrs"><p>When C pointer doesn&#8217;t mean that argument is passed by reference, it is passed
and returned as opaque <tt>TYPE(C_PTR)</tt> entity. This is sufficient for the most
functions and macros. However, <tt>luaL_addchar</tt> and <tt>luaL_addsize</tt> macros use
pointer arithmetics. To make it, the pointers are converted to (and back)
<tt>C_INTPTR_T</tt> addresses with the <tt>TRANSFER</tt> intrinsic.</p></div>
<div class="admonitionblock">
<table><tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">We assume that the <tt>TYPE(C_PTR)</tt> datum is physically the same as
corresponding C pointer value and as the <tt>INTEGER(C_INTPTR_T)</tt> value. This
assumption was tested for GNU and Intel Fortran compilers.</td>
</tr></table>
</div>
</div>
<div class="sect2">
<h3 id="_fortran_constants">Fortran constants</h3>
<div class="paragraph"><p>Lua has constants which are defined in header files. Some are chosen during
installation: <tt>LUA_MINSTACK</tt> and <tt>LUA_IDSIZE</tt>. The constant <tt>LUAL_BUFFERSIZE</tt>
depends on OS parameters.</p></div>
<div class="paragraph"><p>Since there is no way to read these header files in Fortran, you
should specify the configuration constants in Fortran file <em>luaf_conf.fi</em>
manually or generate this file with <em>genconf</em> utility (see <a href="#src">Sources</a>,
<a href="#inst">Installation</a> sections).</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_source_structure">Source structure</h2>
<div class="sectionbody">
<div class="paragraph" id="src"><p>The project consists of main file <em>luaf.f90</em> and include files:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>luaf_int.fi</em> contains generated bindings,
</p>
</li>
<li>
<p>
<em>luaf_const.fi</em> contains generated definitions of constants,
</p>
</li>
<li>
<p>
<em>luaf_conf.fi</em> contains definition of configuration constants.
</p>
</li>
</ul></div>
<div class="paragraph"><p><em>genconf</em> (compiled from <em>genconf.c</em> source) is a simple tool to generate
<em>luaf_conf.fi</em> from current Lua installation and system settings. It writes
contents of <em>luaf_conf.fi</em> to <tt>stdout</tt>. The typical usage is:</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>gcc genconf.c -o genconf -I /usr/include/lua5.1
./genconf &gt; luaf_conf.fi</tt></pre>
</div></div>
<div class="paragraph"><p>Templates of configuration file are called <em>luaf_conf_linux.fi</em> and
<em>luaf_conf_win.fi</em>. They contain default Lua values of <tt>LUA_MINSTACK</tt> and
<tt>LUA_IDSIZE</tt> and system-specific buffer sizes <tt>LUAL_BUFFERSIZE</tt>.</p></div>
<div class="paragraph"><p>There is also <em>test</em> directory which contains test file and build file for
CMake.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_installation">Installation</h2>
<div class="sectionbody">
<div class="paragraph" id="inst"><p>No special installation is intended.</p></div>
<div class="paragraph"><p>First, generate the file <em>luaf_conf.fi</em>. Or use template file and edit it by
hand. Next, just copy the following files to your project:</p></div>
<div class="ulist"><ul>
<li>
<p>
<em>luaf.f90</em>
</p>
</li>
<li>
<p>
<em>luaf_int.fi</em>
</p>
</li>
<li>
<p>
<em>luaf_const.fi</em>
</p>
</li>
<li>
<p>
<em>luaf_conf.fi</em>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Then, include <tt>USE LUAF</tt> in your project where the bindings are required.</p></div>
<div class="paragraph"><p>Please see <em>test/CMakeLists.txt</em> for example of compilation scenario. It includes
auto-generation of <em>luaf_conf.fi</em> file.</p></div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2013-12-29 23:18:44 MSK
</div>
</div>
</body>
</html>
